<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Pathway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        :root {
            --text-color: #ffffff;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent-color: #ff4081;
            --accent-hover: #e91e63;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: 76px;
            /* Account for fixed navbar */
        }
        
        
        .card {
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-wrap: break-word;
            background-color: var(--card-bg, #2c2f33);
            color: var(--card-text, #ffffff);
            perspective: 1000px;
            position: relative;
            margin-bottom: 2rem;
            transition: background-color 0.3s, color 0.3s;
        }

        .card-body {
            padding: 1.5rem;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            transform-origin: center right;
        }

        .card.loading .card-body {
            transform: rotateY(180deg);
        }

        .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .card.loading .spinner-border {
            display: block;
        }

        .btn-primary {
            background-color: #ff4081;
            border-color: #ff4081;
            transition: background-color 0.3s, border-color 0.3s;
            position: relative;
        }

        .btn-primary:hover {
            background-color: #e91e63;
            border-color: #e91e63;
        }

        .btn-spinner {
            display: none;
            position: absolute;
            right: 1rem;
        }

        .btn-primary.loading .btn-spinner {
            display: inline-block;
        }

        .btn-primary.loading .btn-text {
            visibility: hidden;
        }

        body.light-mode .card {
            background-color: #ffffff;
            color: #000000;
        }

        body.light-mode .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        body.light-mode .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        body.light-mode .text-light {
            color: #000000 !important;
        }

        body.light-mode .bg-dark {
            background-color: #ffffff !important;
        }

        .svg-container {
            width: 100%;
            height: 80vh;
            background-color: var(--card-bg, #2c2f33);
            color: var(--card-text, #ffffff);
            border-radius: 20px;
            padding: 1.5rem;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .svg-container {
                height: 60vh;
            }
        }

        /* User profile styles */
        .profile-summary {
            margin-bottom: 2rem;
        }

        .profile-summary p {
            margin-bottom: 0.5rem;
        }

        /* Navigation styles */
        .navbar {
            background: rgba(0, 0, 0, 0.7) !important;
            backdrop-filter: blur(10px);
            padding: 0.8rem 1rem;
        }
        
        .navbar-brand {
            color: var(--text-color);
            font-weight: bold;
        }
        
        .nav-link {
            color: var(--text-color) !important;
            margin: 0 5px;
            transition: color 0.3s;
        }
        
        .nav-link:hover {
            color: var(--accent-color) !important;
        }
        
        .dropdown-menu {
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--accent-color);
        }
        
        .dropdown-item {
            color: var(--text-color);
        }
        
        .dropdown-item:hover {
            background-color: var(--accent-color);
            color: white;
        }
        /* Light mode styles */
        body.light-mode {
            --text-color: #212529;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --accent-color: #ff4081;
            --accent-hover: #e91e63;
        }
        
        body.light-mode .navbar {
            background: rgba(248, 249, 250, 0.7) !important;
        }
        
        body.light-mode .dropdown-menu {
            background-color: rgba(248, 249, 250, 0.9);
            border: 1px solid var(--accent-color);
        }
        
        /* Add padding for fixed-top navbar */
        .card {
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.7) !important;
            color: var(--card-text);
        }

        .card-body {
            padding: 1.5rem;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
    </style>
</head>

<body class="dark-mode">
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="logo2-removebg-preview.png" alt="VisionVenture" style="width: 100%;
  height: 60px;
  object-fit: cover;
   overflow: hidden; display: block; margin: auto;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <!-- Logged-in navigation items -->
                    <li class="nav-item logged-in-nav">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item logged-in-nav">
                        <a class="nav-link" href="career-pathway.html">
                            <i class="fas fa-road"></i> Career Pathway
                        </a>
                    </li>
                    <li class="nav-item logged-in-nav">
                        <a class="nav-link" href="resume-advice.html">
                            <i class="fas fa-file-alt"></i> Resume Advice
                        </a>
                    </li>
                    <!-- Profile Dropdown -->
                    <li class="nav-item dropdown logged-in-nav">
                        <a class="nav-link dropdown-toggle" href="#" id="profileMenu" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i> <span class="username">User</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="profileMenu">
                            <li><a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user"></i> Account</a></li>
                            <li><a class="dropdown-item" href="settings.html">
                                    <i class="fas fa-cog"></i> Settings</a></li>
                            <li><a class="dropdown-item" href="login.html" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item logged-in-nav">
                        <a class="nav-link" href="step1.html">
                            <i class="fas fa-road"></i> Complete Profile
                        </a>
                    </li>
                    <!-- Logged-out navigation items -->
                    <!-- <li class="nav-item logged-out-nav">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item logged-out-nav">
                        <a class="nav-link" href="signup.html">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </a>
                    </li> -->
                    <!-- Mode Switch Icon -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="modeSwitch" onclick="toggleMode()">
                            <i class="fas fa-moon"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5 fade-in">
        <h2 class="text-center mb-4 text-light mode-dependent-text">Interactive Career Pathway</h2>

        <!-- User Profile Summary -->
        <div class="card fade-in profile-summary">
            <div class="card-body">
                <h3 class="card-title mode-dependent-text">Your Profile</h3>
                <div id="user-summary" class="mt-3">
                    <!-- Profile data will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Career Pathway Visualization -->
        <div class="card fade-in">
            <div class="card-body">
                <button id="refreshPathway" class="btn btn-primary mb-4 w-100">
                    <span class="btn-text">Generate Career Pathway</span>
                    <span class="spinner-border spinner-border-sm btn-spinner" role="status" aria-hidden="true"></span>
                </button>
                <div class="spinner-border text-light" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div id="careerPathway" class="svg-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication status
            // const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            // if (isLoggedIn) {
            //     document.querySelectorAll('.logged-out-nav').forEach(el => el.style.display = 'none');
            //     document.querySelectorAll('.logged-in-nav').forEach(el => el.style.display = 'block');
                
            //     // Set username if available
            //     const username = sessionStorage.getItem('username');
            //     if (username) {
            //         document.querySelector('.username').textContent = username;
            //     }
            // } else {
            //     document.querySelectorAll('.logged-out-nav').forEach(el => el.style.display = 'block');
            //     document.querySelectorAll('.logged-in-nav').forEach(el => el.style.display = 'none');
            // }

            // Initialize theme
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDarkScheme) {
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
            }

            // Load user profile from session storage
            const profile = JSON.parse(sessionStorage.getItem('userProfile')) || {};
            if (profile) {
                // Display user profile summary
                document.getElementById('user-summary').innerHTML = `
                    <p><strong>Bio:</strong> ${profile.bio || 'Not provided'}</p>
                    <p><strong>Skills:</strong> ${profile.skills || 'Not provided'}</p>
                    <p><strong>Career Goals:</strong> ${profile.careerGoals || 'Not provided'}</p>
                    <p><strong>Location:</strong> ${profile.location || 'Not provided'}</p>
                    <p><strong>Experience:</strong> ${profile.experience || 'Not provided'} years</p>
                `;
            }

            // Generate career pathway button
            document.getElementById('refreshPathway').addEventListener('click', function () {
                generateCareerPathway(this);
            });
        });

        function setLoadingState(button, loading) {
            const cardBody = button.closest('.card-body');
            if (loading) {
                cardBody.classList.add('loading');
                button.classList.add('loading');
                button.disabled = true;
            } else {
                cardBody.classList.remove('loading');
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        async function generateCareerPathway(button) {
            setLoadingState(button, true);

            const profile = JSON.parse(sessionStorage.getItem('userProfile'));
            if (!profile || !profile.skills || !profile.careerGoals) {
                alert('Please complete your profile first on the home page.');
                setLoadingState(button, false);
                return;
            }

            const promptTemplate = `Create a career pathway graph for someone with these skills: '${profile.skills}' and these career goals: '${profile.careerGoals}'. 
            Return a JSON object with 'nodes' and 'links' arrays for D3.js visualization. 
            Each node should have 'id', 'name', and 'level' properties. 
            Each link should have 'source', 'target', and 'value' properties. 
            Structure the pathway from current skills to career goals with intermediate roles, skills, and certifications.
            Format as valid JSON only, no explanations.`;

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyDNeMYy5q3mGJv7-Bj6KMwPmDL6f51RJ9s`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptTemplate }] }],
                        }),
                    }
                );

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                // Extract JSON from the response (Gemini might wrap it in code blocks)
                let jsonData;
                try {
                    // Check if the text contains a code block
                    const jsonMatch = text.match(/```(?:json)?([\s\S]*?)```/);
                    if (jsonMatch && jsonMatch[1]) {
                        jsonData = JSON.parse(jsonMatch[1].trim());
                    } else {
                        // Try to parse the whole text as JSON
                        jsonData = JSON.parse(text);
                    }

                    drawCareerPathway(jsonData);
                } catch (jsonError) {
                    console.error('Error parsing JSON:', jsonError);
                    alert('Error generating pathway. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error connecting to the API. Please try again.');
            } finally {
                setLoadingState(button, false);
            }
        }

        function drawCareerPathway(careerPathwayData) {
            d3.select('#careerPathway').select('svg').remove();

            if (!careerPathwayData.nodes || !careerPathwayData.nodes.length) {
                console.log("No career pathway data available.");
                return;
            }

            const container = document.getElementById('careerPathway');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select('#careerPathway').append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', 'transparent')
                .append('g');

            // Add zoom functionality
            const zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', (event) => {
                    svg.attr('transform', event.transform);
                });

            d3.select('#careerPathway svg').call(zoom);

            // Define color scale for node levels
            const colorScale = d3.scaleOrdinal()
                .domain(['beginner', 'intermediate', 'advanced', 'expert', 'goal'])
                .range(['#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#f44336']);

            // Create arrow markers for the links
            svg.append('defs').selectAll('marker')
                .data(['arrow'])
                .enter().append('marker')
                .attr('id', d => d)
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 25)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#999');

            const simulation = d3.forceSimulation(careerPathwayData.nodes)
                .force('link', d3.forceLink(careerPathwayData.links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collide', d3.forceCollide().radius(60));

            const link = svg.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(careerPathwayData.links)
                .enter().append('line')
                .attr('stroke-width', d => d.value || 2)
                .attr('stroke', '#999')
                .attr('marker-end', 'url(#arrow)');

            const nodeGroup = svg.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(careerPathwayData.nodes)
                .enter().append('g');

            const node = nodeGroup.append('circle')
                .attr('r', d => d.level === 'goal' ? 25 : 20)
                .attr('fill', d => colorScale(d.level || 'intermediate'))
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add a subtle pulsing animation to goal nodes
            nodeGroup.filter(d => d.level === 'goal')
                .append('circle')
                .attr('r', 25)
                .attr('fill', 'none')
                .attr('stroke', '#f44336')
                .attr('stroke-width', 2)
                .attr('opacity', 0.7)
                .append('animate')
                .attr('attributeName', 'r')
                .attr('values', '25;35;25')
                .attr('dur', '3s')
                .attr('repeatCount', 'indefinite');

            const label = nodeGroup.append('text')
                .attr('dy', 30)
                .attr('text-anchor', 'middle')
                .text(d => formatNodeLabel(d.name))
                .style('font-size', '12px')
                .style('fill', document.body.classList.contains('light-mode') ? '#000' : '#fff')
                .style('pointer-events', 'none')
                .style('text-shadow', '0 1px 2px rgba(0,0,0,0.8)');

            // Add tooltips
            nodeGroup.append('title')
                .text(d => d.name);

            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodeGroup.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function formatNodeLabel(text) {
            // Truncate long labels
            return text.length > 20 ? text.substring(0, 17) + '...' : text;
        }

        // Dark/Light mode toggle function
        function toggleMode() {
            document.body.classList.toggle('light-mode');
            const isDarkMode = !document.body.classList.contains('light-mode');
            document.getElementById('modeSwitch').innerHTML = isDarkMode ? 
                '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('username');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>